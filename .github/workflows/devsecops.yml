name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
    # 1. Obtener c√≥digo
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Setup Node.js (OBLIGATORIO)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    # 3. Preparar Docker
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 4. CI + SCA ‚Äì users-service
    - name: CI users-service
      run: |
        cd users-service
        npm ci
        npm audit --audit-level=critical
        npm run lint || true
        npm test

    # 5. CI + SCA ‚Äì academic-service
    - name: CI academic-service
      run: |
        cd academic-service
        npm ci
        npm audit --audit-level=critical
        npm run lint || true
        npm test

    # 6. CI + SCA ‚Äì api-gateway
    - name: CI api-gateway
      run: |
        cd api-gateway
        npm ci
        npm audit --audit-level=critical
        npm run lint || true
        npm test

    # 7. üîê SAST ‚Äì Semgrep
    - name: Install Semgrep
      run: |
        python3 -m pip install --upgrade pip
        pip install semgrep

    - name: SAST users-service
      run: |
        cd users-service
        semgrep --config=auto --severity=ERROR

    - name: SAST academic-service
      run: |
        cd academic-service
        semgrep --config=auto --severity=ERROR

    - name: SAST api-gateway
      run: |
        cd api-gateway
        semgrep --config=auto --severity=ERROR

    # 8. Build ‚Äì Docker
    - name: Build images with Docker Compose
      run: docker compose build

    # 9. üîç Container Security ‚Äì Trivy
    - name: Trivy scan users-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: users-service:latest
        severity: CRITICAL
        exit-code: 1

    - name: Trivy scan academic-service
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: academic-service:latest
        severity: CRITICAL
        exit-code: 1

    - name: Trivy scan api-gateway
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: api-gateway:latest
        severity: CRITICAL
        exit-code: 1

    # 10. CD ‚Äì Deploy
    - name: Deploy with Docker Compose
      if: success()
      run: docker compose up -d

    # 11. Smoke tests
    - name: Smoke test API Gateway
      if: success()
      run: |
        sleep 15
        curl -f http://localhost:3000/users
        curl -f http://localhost:3000/courses

    # 12. Limpieza
    - name: Shutdown services
      if: always()
      run: docker compose down